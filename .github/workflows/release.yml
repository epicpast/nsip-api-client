name: Release

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'packaging/**'

permissions:
  contents: write
  packages: write

jobs:
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    # Skip if this is a version bump commit (checked via commit message in if condition, not run command)
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      client_changed: ${{ steps.changes.outputs.client }}
      server_changed: ${{ steps.changes.outputs.server }}
      skills_changed: ${{ steps.changes.outputs.skills }}
      any_changed: ${{ steps.changes.outputs.client == 'true' || steps.changes.outputs.server == 'true' || steps.changes.outputs.skills == 'true' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Detect file changes
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          client:
            - 'src/nsip_client/**'
            - 'packaging/nsip-client/**'
          server:
            - 'src/nsip_mcp/**'
            - 'packaging/nsip-mcp-server/**'
          skills:
            - 'src/nsip_skills/**'
            - 'packaging/nsip-skills/**'

  bump-and-tag:
    name: Bump Version and Tag
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      client_version: ${{ steps.versions.outputs.client_version }}
      server_version: ${{ steps.versions.outputs.server_version }}
      skills_version: ${{ steps.versions.outputs.skills_version }}
      release_tag: ${{ steps.versions.outputs.release_tag }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Bump versions
      id: bump
      env:
        CLIENT_CHANGED: ${{ needs.detect-changes.outputs.client_changed }}
        SERVER_CHANGED: ${{ needs.detect-changes.outputs.server_changed }}
        SKILLS_CHANGED: ${{ needs.detect-changes.outputs.skills_changed }}
      run: |
        # Determine which packages to bump based on changes
        if [ "$CLIENT_CHANGED" = "true" ] && [ "$SERVER_CHANGED" = "true" ] && [ "$SKILLS_CHANGED" = "true" ]; then
          echo "Bumping all packages"
          python scripts/bump_version.py --package all --bump patch
        elif [ "$CLIENT_CHANGED" = "true" ] && [ "$SERVER_CHANGED" = "true" ]; then
          echo "Bumping client and server"
          python scripts/bump_version.py --package client --bump patch
          python scripts/bump_version.py --package server --bump patch
        elif [ "$CLIENT_CHANGED" = "true" ] && [ "$SKILLS_CHANGED" = "true" ]; then
          echo "Bumping client and skills"
          python scripts/bump_version.py --package client --bump patch
          python scripts/bump_version.py --package skills --bump patch
        elif [ "$SERVER_CHANGED" = "true" ] && [ "$SKILLS_CHANGED" = "true" ]; then
          echo "Bumping server and skills"
          python scripts/bump_version.py --package server --bump patch
          python scripts/bump_version.py --package skills --bump patch
        elif [ "$CLIENT_CHANGED" = "true" ]; then
          echo "Bumping client only"
          python scripts/bump_version.py --package client --bump patch
        elif [ "$SERVER_CHANGED" = "true" ]; then
          echo "Bumping server only"
          python scripts/bump_version.py --package server --bump patch
        elif [ "$SKILLS_CHANGED" = "true" ]; then
          echo "Bumping skills only"
          python scripts/bump_version.py --package skills --bump patch
        fi

    - name: Extract versions
      id: versions
      run: |
        CLIENT_VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' src/nsip_client/__init__.py)
        SERVER_VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' src/nsip_mcp/__init__.py)
        SKILLS_VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' src/nsip_skills/__init__.py)
        echo "client_version=$CLIENT_VERSION" >> "$GITHUB_OUTPUT"
        echo "server_version=$SERVER_VERSION" >> "$GITHUB_OUTPUT"
        echo "skills_version=$SKILLS_VERSION" >> "$GITHUB_OUTPUT"
        # Use the highest version as the release tag
        HIGHEST=$(printf '%s\n' "$CLIENT_VERSION" "$SERVER_VERSION" "$SKILLS_VERSION" | sort -V | tail -n1)
        echo "release_tag=v$HIGHEST" >> "$GITHUB_OUTPUT"

    - name: Commit version changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git diff --staged --quiet || git commit -m "chore: bump version [skip ci]"
        git push

    - name: Create release tag
      env:
        RELEASE_TAG: ${{ steps.versions.outputs.release_tag }}
      run: |
        git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG"
        git push origin "$RELEASE_TAG"

  build-and-release:
    name: Build and Release
    needs: [detect-changes, bump-and-tag]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: ${{ needs.bump-and-tag.outputs.release_tag }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine hatchling

    - name: Build packages
      run: |
        mkdir -p dist

        # Build client
        cd packaging/nsip-client
        python -m build
        cp dist/* ../../dist/
        cd ../..

        # Build server
        cd packaging/nsip-mcp-server
        python -m build
        cp dist/* ../../dist/
        cd ../..

        # Build skills
        cd packaging/nsip-skills
        python -m build
        cp dist/* ../../dist/
        cd ../..

        # Verify all packages
        twine check dist/*

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.bump-and-tag.outputs.release_tag }}
        name: Release ${{ needs.bump-and-tag.outputs.release_tag }}
        body: |
          ## Packages

          - **nsip-client**: ${{ needs.bump-and-tag.outputs.client_version }}
          - **nsip-mcp-server**: ${{ needs.bump-and-tag.outputs.server_version }}
          - **nsip-skills**: ${{ needs.bump-and-tag.outputs.skills_version }}

          ## Installation

          ```bash
          # Install the API client
          pip install ./nsip_client-${{ needs.bump-and-tag.outputs.client_version }}-py3-none-any.whl

          # Install the MCP server (includes client as dependency)
          pip install ./nsip_mcp_server-${{ needs.bump-and-tag.outputs.server_version }}-py3-none-any.whl

          # Install the breeding tools (includes client as dependency)
          pip install ./nsip_skills-${{ needs.bump-and-tag.outputs.skills_version }}-py3-none-any.whl
          ```

          ## Changes

          See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/docs/CHANGELOG.md) for details.
        files: dist/*
        draft: false
        prerelease: false
        generate_release_notes: true

    - name: Upload release artifacts
      uses: actions/upload-artifact@v6
      with:
        name: release-${{ needs.bump-and-tag.outputs.release_tag }}
        path: dist/
        retention-days: 90

  build-docker:
    name: Build and Push Docker Image
    needs: [bump-and-tag, build-and-release]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        ref: ${{ needs.bump-and-tag.outputs.release_tag }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=raw,value=latest
          type=raw,value=${{ needs.bump-and-tag.outputs.server_version }}
          type=raw,value=${{ needs.bump-and-tag.outputs.release_tag }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      env:
        SERVER_VERSION: ${{ needs.bump-and-tag.outputs.server_version }}
      run: |
        docker pull "ghcr.io/${{ github.repository }}:$SERVER_VERSION"
        docker run --rm "ghcr.io/${{ github.repository }}:$SERVER_VERSION" python -c "import nsip_client; import nsip_mcp; print('Imports OK')"
