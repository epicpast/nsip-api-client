name: Release

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'packaging/**'

permissions:
  contents: write

jobs:
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    # Skip if this is a version bump commit (checked via commit message in if condition, not run command)
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      client_changed: ${{ steps.changes.outputs.client }}
      server_changed: ${{ steps.changes.outputs.server }}
      any_changed: ${{ steps.changes.outputs.client == 'true' || steps.changes.outputs.server == 'true' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect file changes
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          client:
            - 'src/nsip_client/**'
            - 'packaging/nsip-client/**'
          server:
            - 'src/nsip_mcp/**'
            - 'packaging/nsip-mcp-server/**'

  bump-and-tag:
    name: Bump Version and Tag
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      client_version: ${{ steps.versions.outputs.client_version }}
      server_version: ${{ steps.versions.outputs.server_version }}
      release_tag: ${{ steps.versions.outputs.release_tag }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Bump versions
      id: bump
      env:
        CLIENT_CHANGED: ${{ needs.detect-changes.outputs.client_changed }}
        SERVER_CHANGED: ${{ needs.detect-changes.outputs.server_changed }}
      run: |
        if [ "$CLIENT_CHANGED" = "true" ] && [ "$SERVER_CHANGED" = "true" ]; then
          echo "Bumping both packages"
          python scripts/bump_version.py --package both --bump patch
        elif [ "$CLIENT_CHANGED" = "true" ]; then
          echo "Bumping client only"
          python scripts/bump_version.py --package client --bump patch
        elif [ "$SERVER_CHANGED" = "true" ]; then
          echo "Bumping server only"
          python scripts/bump_version.py --package server --bump patch
        fi

    - name: Extract versions
      id: versions
      run: |
        CLIENT_VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' src/nsip_client/__init__.py)
        SERVER_VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' src/nsip_mcp/__init__.py)
        echo "client_version=$CLIENT_VERSION" >> "$GITHUB_OUTPUT"
        echo "server_version=$SERVER_VERSION" >> "$GITHUB_OUTPUT"
        # Use the higher version as the release tag
        if [ "$(printf '%s\n' "$CLIENT_VERSION" "$SERVER_VERSION" | sort -V | tail -n1)" = "$CLIENT_VERSION" ]; then
          echo "release_tag=v$CLIENT_VERSION" >> "$GITHUB_OUTPUT"
        else
          echo "release_tag=v$SERVER_VERSION" >> "$GITHUB_OUTPUT"
        fi

    - name: Commit version changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git diff --staged --quiet || git commit -m "chore: bump version [skip ci]"
        git push

    - name: Create release tag
      env:
        RELEASE_TAG: ${{ steps.versions.outputs.release_tag }}
      run: |
        git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG"
        git push origin "$RELEASE_TAG"

  build-and-release:
    name: Build and Release
    needs: [detect-changes, bump-and-tag]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.bump-and-tag.outputs.release_tag }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine hatchling

    - name: Build packages
      run: |
        mkdir -p dist

        # Build client
        cd packaging/nsip-client
        python -m build
        cp dist/* ../../dist/
        cd ../..

        # Build server
        cd packaging/nsip-mcp-server
        python -m build
        cp dist/* ../../dist/
        cd ../..

        # Verify all packages
        twine check dist/*

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RELEASE_TAG: ${{ needs.bump-and-tag.outputs.release_tag }}
        CLIENT_VERSION: ${{ needs.bump-and-tag.outputs.client_version }}
        SERVER_VERSION: ${{ needs.bump-and-tag.outputs.server_version }}
      with:
        tag_name: ${{ needs.bump-and-tag.outputs.release_tag }}
        name: Release ${{ needs.bump-and-tag.outputs.release_tag }}
        body: |
          ## Packages

          - **nsip-client**: ${{ needs.bump-and-tag.outputs.client_version }}
          - **nsip-mcp-server**: ${{ needs.bump-and-tag.outputs.server_version }}

          ## Installation

          ```bash
          # Install the API client
          pip install ./nsip_client-${{ needs.bump-and-tag.outputs.client_version }}-py3-none-any.whl

          # Install the MCP server (includes client as dependency)
          pip install ./nsip_mcp_server-${{ needs.bump-and-tag.outputs.server_version }}-py3-none-any.whl
          ```

          ## Changes

          See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/docs/CHANGELOG.md) for details.
        files: dist/*
        draft: false
        prerelease: false
        generate_release_notes: true

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      env:
        RELEASE_TAG: ${{ needs.bump-and-tag.outputs.release_tag }}
      with:
        name: release-${{ needs.bump-and-tag.outputs.release_tag }}
        path: dist/
        retention-days: 90
